<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab4</title>
</head>
<body>
    <h1>Baza kontrehentów</h1>

    <div>
        <form id="add-form" onsubmit="return add(event)">
            Nazwa: <input id="" type="text">
            Nip: <input type="text">
            <input type="submit" value="Dodaj">
        </form>
       
    </div>

    <table id="data-table">
        <tr>
            <th>Id</th>
            <th>Nazwa</th>
            <th>Nip</th>
            <th>Dodano</th>
        </tr>
    </table>

    <script>
        //prefixes of implementation that we want to test
        window.indexedDB =
            window.indexedDB ||
            window.mozIndexedDB ||
            window.webkitIndexedDB ||
            window.msIndexedDB;

        //prefixes of window.IDB objects
        window.IDBTransaction =
            window.IDBTransaction ||
            window.webkitIDBTransaction ||
            window.msIDBTransaction;
        window.IDBKeyRange =
            window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange;

        if (!window.indexedDB) {
            window.alert(
            "Your browser doesn't support a stable version of IndexedDB."
            );
        }

        let db;
        let request = window.indexedDB.open("newDatabase", 1);

        request.onerror = function (event) {
            console.log("error: The database is opened failed");
        };

        request.onsuccess = function (event) {
            db = request.result;
            console.log("success: The database " + db + " is opened successfully");

            renderTable();
        };

        request.onupgradeneeded = function (event) {
            var db = event.target.result;
            var objectStore = db.createObjectStore("contractors", {
                autoIncrement: true,
            });

            objectStore.createIndex("name", "name", { unique: true });
            objectStore.createIndex("nip", "nip", { unique: true });
            objectStore.createIndex("created", "created", { unique: false });

            // for (var i in clientData) {
            // objectStore.add(clientData[i]);
            // }
        };


        const btn = document.getElementById("add-btn");
        const table = document.getElementById("data-table");

        function add(ev){
            ev.preventDefault();

            let form = document.getElementById("add-form");

            let contractor = {
                name: form[0].value,
                nip: form[0].value,
                created: new Date()
            }

            console.log(contractor)

            var request = db
            .transaction(["contractors"], "readwrite")
            .objectStore("contractors")
            .add(contractor);

            request.onsuccess = function (event) {
                console.log("Client added");
                // drawTable();
            };

            request.onerror = function (event) {
                alert(
                    "Unable to add data\r\ user with that email aready exist in your database! "
                );
            };
        }

        function renderTable(){
            const objectStore = db.transaction('contractors').objectStore('contractors');
            objectStore.openCursor().onsuccess = (event) => {
                const cursor = event.target.result;
                // Check if there are no (more) cursor items to iterate through
                if (!cursor) {
                    // No more items to iterate through, we quit.
                    // note.appendChild(createListItem('Entries all displayed.'));
                    console.log("no cursors")
                    return;
                }

                const key = cursor.key;
                const { name, nip, created } = cursor.value;

                let rowEl = document.createElement("tr");
                addColumn(rowEl, key)
                addColumn(rowEl, name)
                addColumn(rowEl, nip)
                addColumn(rowEl, created)

                table.appendChild(rowEl)

                
                
                // Check which suffix the deadline day of the month needs
                // const { hours, minutes, day, month, year, notified, taskTitle } = cursor.value;
                // const ordDay = ordinal(day);

                // // Build the to-do list entry and put it into the list item.
                // const toDoText = `${taskTitle} — ${hours}:${minutes}, ${month} ${ordDay} ${year}.`;
                // const listItem = createListItem(toDoText);

                // if (notified === 'yes') {
                //     listItem.style.textDecoration = 'line-through';
                //     listItem.style.color = 'rgba(255, 0, 0, 0.5)';
                // }

                // // Put the item item inside the task list
                // taskList.appendChild(listItem);

                // // Create a delete button inside each list item,
                // const deleteButton = document.createElement('button');
                // listItem.appendChild(deleteButton);
                // deleteButton.textContent = 'X';
                
                // // Set a data attribute on our delete button to associate the task it relates to.
                // deleteButton.setAttribute('data-task', taskTitle);
                
                // // Associate action (deletion) when clicked
                // deleteButton.onclick = (event) => {
                //     deleteItem(event);
                // };

                // continue on to the next item in the cursor
                cursor.continue();
            };

            function addColumn(row, value){
                let col = document.createElement("td");
                col.innerText = value
                row.appendChild(col)
            }
        }
    </script>
</body>
</html>